include:
  - local: 'docker-login.yml'
build-k8s-image:
  stage: build-k8s-image
  extends: .qsc-registry-login
  services:
    - name: reg.qschou.com/ops/docker:27.4.0-dind
      command: ["--host=tcp://0.0.0.0:2375", "--host=unix:///var/run/docker.sock"]
      alias: docker
  script:
    - sleep 15
    #- time=$(date -u -d '+8 hour' +"%Y%m%d%H%M%S")
    - export BUILD_TIME=$(date -d "$CI_PIPELINE_CREATED_AT +8 hour" +"%Y%m%d%H%M%S")
    - tag=${CI_COMMIT_TAG:-$CI_COMMIT_BRANCH}
    - docker build -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:$tag-$CI_COMMIT_SHORT_SHA-$BUILD_TIME .
    - docker images
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:$tag-$CI_COMMIT_SHORT_SHA-$BUILD_TIME
  rules:
    - if: '$CI_COMMIT_REF_NAME == "test" || $CI_COMMIT_TAG =~ /^prod-v\d+\.\d+\.\d+$/'
      when: on_success 
    - when: never
  timeout: 5m
