include:
  - local: 'docker-login.yml'
build-k8s-image:
  stage: build-k8s-image
  extends: .qsc-registry-login 
  services:
    - name: reg.qschou.com/ops/docker:27.4.0-dind
      command: ["--host=tcp://0.0.0.0:2375", "--host=unix:///var/run/docker.sock"]
      alias: docker
  script:
    - sleep 10
    - time=$(date +%Y%m%d%H%M%S)
    - tag=${CI_COMMIT_TAG:-$CI_COMMIT_BRANCH}
    - docker build -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:$tag-$CI_COMMIT_SHORT_SHA-$time .
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:$tag-$CI_COMMIT_SHORT_SHA-$time
    - docker images
  timeout: 3m
  rules:
    - when: on_success 
